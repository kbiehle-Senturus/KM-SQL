/*
 * R_INVENTORY_METRICS table load Script to KMDWH
 * 
 */

insert into  KMDWH.dbo.R_Script_Process_Log 
select
'Start' --table name
,0 -- 
,'***Inventory Load Script Start'
,current_timestamp 
from 
(select dateskid from KMDWH.dbo.d_date where dateskid = 20200101 group by dateskid) a
;






/* Step 1:  create Site/Sku/Date detail of KMDWH.dbo.f_inventory
 *  with 90 Day Averages for Qty On Hand (count and value)
 * 
 * table name: #temp_90DayAvgs 
 * expected runtime: 3-4 minutes
 * approx rows inserted: 28MM

 * */

SELECT x.*
		,avg(x.QOH_Value) OVER ( PARTITION BY x.siteskid ,x.itemskid ORDER BY x.DATE rows BETWEEN 89 preceding  AND CURRENT row ) AS QOH_Value_90D_avg
		,avg(x.QOH_qty) OVER ( PARTITION BY x.siteskid ,x.itemskid ORDER BY x.DATE rows BETWEEN 89 preceding AND CURRENT row ) AS QOH_Qty_90D_avg
	
		into #temp_90DayAvgs 
	
		from 
	(
	--Daily Site/Item/SKU Inventory Last 90 Days
	SELECT 
		v.SiteSkId
			,v.ItemSkId 
			,d.DATE
		,d2.DATE AS LastSoldDt
		,d3.date as LastOrdDt
		,d4.date as LastRcvdDt
		,(v.QtyOnHand) QOH_qty
		,(v.ReplacementCostAmt * v.QtyOnHand) QOH_Value
		,(v.QtyInTransit) QIT_qty
		,(v.ReplacementCostAmt * v.QtyInTransit) QIT_Value
		,(v.QtyRsvd) QR_qty
		,(v.ReplacementCostAmt * v.QtyRsvd) QR_Value
		,(v.QtyOnOrd) QO_qty
		,(v.ReplacementCostAmt * v.QtyOnOrd) QO_Value
		,(v.qtyOnBackord) QBO_qty
		,(v.ReplacementCostAmt * v.qtyOnBackord) QBO_Value
	FROM KMDWH.dbo.f_inventory v
	JOIN KMDWH.dbo.d_item i ON v.ItemSkId = i.ItemSkId
	JOIN KMDWH.dbo.d_site s ON v.SiteSkId = s.SiteSKId
	JOIN KMDWH.dbo.d_date d ON v.DateSkId = d.DateSkId
	LEFT OUTER JOIN KMDWH.dbo.d_date d2 ON v.LastSoldDt = d2.DateSkId
	left outer join KMDWH.dbo.d_date d3 ON v.LastOrdDt = d3.DateSkId
	left outer join KMDWH.dbo.d_date d4 ON v.LastRcvdDt = d4.DateSkId
	
	WHERE 
	
		datediff(day, d.DATE, current_timestamp) <= 90 -- only the last 90 days from current Date
	AND i.ItemDeptNo IN ( '100' ,'200' ,'300' ,'400' ) -- Only Depts 100 - 400
	and s.SiteRegionKey IN ( 'EB' ,'INLD' ,'NRTH' ,'STH' ,'SW'  ) -- Only Retail Regions
	AND s.SiteStatus = 'ACTIVE' -- only active stores
	
	) x;  
	
insert into KMDWH.dbo.R_Script_Process_Log 
select
'#temp_90DayAvgs' --table name
,1 -- 
,'create 90 Day Averages'
,current_timestamp 
from 
(select dateskid from KMDWH.dbo.d_date where dateskid = 20200101 group by dateskid) a
;



/* Step 2: create Site/Sku sales metrics 
 *  for the past 365 Days
 * 
 * expected runtime: 
 * table name: #temp_Last365_Sales
 * expected runtime: < 1 minute
 * approx rows inserted: 250K 

 * */

	SELECT 
	p.siteskid
	,p.itemSkid
	,count(DISTINCT d.DATE) total_sales_Days
	,max(p.qty) max_daily_Sale
	,sum(p.qty) Prior_365_QTY
	,sum(p.ExtendedCost) prior_365_COGS
	
	into  #temp_Last365_Sales
			
	FROM KMDWH.dbo.f_pos p  
		join KMDWH.dbo.d_item i on p.ItemSkId = i.itemskid
		JOIN KMDWH.dbo.d_date d ON p.DateSkId = d.DateSkId
	WHERE  datediff(day, d.DATE, current_timestamp) <= 365	
		and  i.ItemDeptNo IN ( '100' ,'200' ,'300' ,'400' )
	
	GROUP BY 
		p.siteskid
		,p.itemSkid
		;		
			
			insert into KMDWH.dbo.R_Script_Process_Log 
			select
			'temp_Last365_Sales' --table name
			,2 -- 
			,'create 365 day lookback - Sales Metrics'
			,current_timestamp 
			from 
			(select dateskid from KMDWH.dbo.d_date where dateskid = 20200101 group by dateskid) a
			;

	
/* Step 3: 
	Reconstiute temp table #temp_90DayAvgs  as temp_SKUDetail
	to include boolen flags for days that skus are each in specific statuses 
 * 
 * expected runtime: 
 * table name: #temp_SKUDetail
 * expected runtime: 10-15 Minutes
 * approx rows inserted: 28MM 
 * */
	
SELECT 
a.siteskid
,a.itemskid
,a.DATE
,a.QOH_qty
,a.QOH_Value
,CASE WHEN LAG(a.Itemskid, 1, 0) OVER ( ORDER BY a.siteskid,a.Itemskid,a.DATE ) = a.Itemskid
		AND LAG(a.QOH_qty, 1, 0) OVER ( ORDER BY a.siteskid,a.Itemskid,a.DATE ) < 0
		AND a.QOH_qty < 0 THEN 1 ELSE 0 END AS negative_day_counter -- was the Sku Qty negative yesterday? 
	,CASE WHEN LAG(a.Itemskid, 1, 0) OVER ( ORDER BY a.siteskid ,a.Itemskid ,a.DATE ) = a.Itemskid
			AND LAG(a.QR_qty, 1, 0) OVER ( ORDER BY a.siteskid ,a.Itemskid ,a.DATE ) > 0
			AND a.QR_qty > 0 THEN 1 ELSE 0 END AS QR_day_counter  -- was the sku on Reserve  yesterday? 
	,CASE WHEN LAG(a.Itemskid, 1, 0) OVER ( ORDER BY a.siteskid ,a.Itemskid ,a.DATE ) = a.Itemskid
			AND LAG(a.QO_qty, 1, 0) OVER ( ORDER BY a.siteskid ,a.Itemskid ,a.DATE ) > 0
			AND a.QO_qty > 0 THEN 1 ELSE 0 END AS QO_day_counter -- was the sku on order  yesterday? 
	,CASE WHEN LAG(a.Itemskid, 1, 0) OVER (ORDER BY a.siteskid,a.Itemskid,a.DATE) = a.Itemskid
			AND LAG(a.QBO_qty, 1, 0) OVER (ORDER BY a.siteskid,a.Itemskid,a.DATE) > 0
			AND a.QBO_qty > 0 THEN 1 ELSE 0 END AS QBO_day_counter   -- was the sku on Backorder  yesterday? 
	,CASE WHEN LAG(a.Itemskid, 1, 0) OVER ( ORDER BY a.siteskid ,a.Itemskid ,a.DATE ) = a.Itemskid
			AND LAG(a.QIT_qty, 1, 0) OVER ( ORDER BY a.siteskid ,a.Itemskid ,a.DATE ) > 0
			AND a.QIT_qty > 0 THEN 1 ELSE 0 END AS QIT_day_counter   -- was the sku on in Transit  yesterday? 
		,CASE  WHEN a.LastSoldDt IS NULL OR datediff(day, a.LastSoldDt, a.DATE) >= 180
				THEN 1
			ELSE 0
			END AS slow_moving_sku 
		,a.QOH_Qty_90D_avg
		,a.QOH_Value_90D_avg
		,a.QIT_qty
		,a.QIT_value
		,a.QR_qty
		,a.QR_value
		,a.QO_qty
		,a.QO_value
		,a.QBO_qty
		,a.QBO_value
		,a.LastSoldDt
		,a.LastOrdDt
		,a.LastRcvdDt
		
	into  #temp_SKUDetail
	
	FROM  #temp_90DayAvgs  a
	;

			insert into KMDWH.dbo.R_Script_Process_Log 
			select
			'temp_SKUDetail' --table name
			,3 -- 
			,'create temp_SKUDetail'
			,current_timestamp 
			from 
			(select dateskid from KMDWH.dbo.d_date where dateskid = 20200101 group by dateskid) a
			;


	
/* Step 4:  
	Transform SKU Detail into reporting table by combining with Sales data
	and transforming boolean flags into Counters by day - how long as a sku been in a specific status
	on a given day. 
 * 
 * expected runtime: 
 * table name: #temp_InventoryMetrics_SKUDetail
 * expected runtime: 6-10 minutes
 * approx rows inserted: 28MM 
 * */


	SELECT
		a.siteskid
		,a.itemskid
		,a.date
		,a.QOH_qty
		,a.QOH_Value
		,a.negative_day_counter
		, CASE WHEN negative_day_counter = 1 THEN sum(negative_day_counter) 
			OVER ( PARTITION BY a.siteskid ,a.itemskid ORDER BY a.DATE rows BETWEEN 7 preceding AND CURRENT row)
			ELSE 0 END AS NQOH_days
		,a.QOH_Qty_90D_avg
		,a.QOH_Value_90D_avg
		,a.QIT_qty
		,a.QIT_value
		,a.QIT_day_counter
		, CASE WHEN QIT_day_counter = 1 THEN sum(QIT_day_counter) 
			OVER ( PARTITION BY a.siteskid ,a.itemskid ORDER BY a.DATE rows BETWEEN 3 preceding AND CURRENT row )
			ELSE 0 END AS QIT_Days
		,a.QR_qty
		,a.QR_value
		,a.QR_day_counter
		, CASE  WHEN QR_day_counter = 1 THEN sum(QR_day_counter)
			OVER ( PARTITION BY a.siteskid ,a.itemskid ORDER BY a.DATE rows BETWEEN 7 preceding AND CURRENT row )
			ELSE 0 END AS QR_Days
		,a.QO_qty
		,a.QO_value
		,a.QO_day_counter
		, CASE  WHEN QO_day_counter = 1 THEN sum(QO_day_counter) 
			OVER ( PARTITION BY a.siteskid ,a.itemskid ORDER BY a.DATE rows BETWEEN 3 preceding AND CURRENT row )
			ELSE 0 END AS QO_Days
		,a.QBO_qty
		,a.QBO_value
		,a.QBO_day_counter
		, CASE  WHEN QBO_day_counter = 1 THEN sum(QBO_day_counter) 
			OVER ( PARTITION BY a.siteskid ,a.itemskid ORDER BY a.DATE rows BETWEEN 7 preceding AND CURRENT row )
			ELSE 0 END AS QBO_Days
		,a.LastSoldDt
		,a.LastOrdDt
		,a.LastRcvdDt
		/*Sales Metrics*/
		,a.slow_moving_sku
		,b.total_sales_Days
		,b.max_daily_Sale
		,b.Prior_365_QTY
		,b.prior_365_COGS
		,cast(CASE  WHEN a.QOH_Value_90D_avg > 0 THEN b.prior_365_COGS / a.QOH_Value_90D_avg
				ELSE 0 END AS DECIMAL(10, 3)) AS Turns
		,cast(b.Prior_365_QTY / 365 AS DECIMAL(10, 3)) AS Qty_Sold_per_day --300 = Number of retail days
		,cast(a.QOH_qty / CASE WHEN b.Prior_365_QTY > 0 THEN cast(b.Prior_365_QTY / 360 AS DECIMAL(10, 3))
				ELSE 1 END AS DECIMAL(10, 3)) AS days_on_hand
		,0 as InvAdj_Value

		into  #temp_InventoryMetrics_SKUDetail
		
			from 
			 #temp_SKUDetail a
			 LEFT OUTER JOIN 
		 	 #temp_Last365_Sales b 
			ON a.siteskid = b.siteskid AND a.itemSkid = b.itemSkid
			;

			insert into KMDWH.dbo.R_Script_Process_Log 
			select
			'temp_InventoryMetrics_SKUDetail' --table name
			,4 -- 
			,'Combine all into SKU Detail'
			,current_timestamp 
			from 
			(select dateskid from KMDWH.dbo.d_date where dateskid = 20200101 group by dateskid) a
			;

		
				
		
/* Step 5: 
	Create  90 Day rolling Adjustments Temp table (tempAdjustments)
 * 
 * expected runtime: 
 * table name: #tempAdjustments
 * expected runtime:  <1 minute
 * approx rows inserted: 10K - 15K  
 * */	
		
		
select 

y.SiteDistrictKey 
,y.SiteRegionKey 
,y.SiteNo 
, dateadd(day,1,y.date)  as date --line dates up with KMDWH.dbo.f_INVENTORY
,dailysales
,TotalSales_90dayRolling
,Defcon_amount
,TotalDefconAmt_90dayRolling
,total_adj_amount
,TotalAdjAmt_90dayRolling

into  #tempAdjustments

from 
(
	select 
		s.SiteDistrictKey 
		,s.SiteRegionKey 
		,s.SiteNo 
		, d.date
			,b.dailySales


	      , sum(b.DailySales) over(partition by a.siteskid order by a.siteskid, d.date rows between 89 preceding and current row) as TotalSales_90dayRolling
			 ,c.Defcon_amount as Defcon_amount
	      , sum(c.Defcon_amount) over(partition by a.siteskid order by a.siteskid, d.date rows between 89 preceding and current row) as TotalDefconAmt_90dayRolling
			,c.total_adj_amount as total_adj_amount
	      , sum(c.total_adj_amount) over(partition by a.siteskid order by a.siteskid, d.date rows between 89 preceding and current row) as TotalAdjAmt_90dayRolling
	  from 
	       (/*Master site crossJoin Date*/
		         select distinct d.dateskid, s.siteskid 
		         from 
		         (select 1 as joinkey, siteskid from KMDWH.dbo.d_site  where SiteStatus  = 'ACTIVE') s
		         full outer join
		         (select 1 as joinkey, dateskid from KMDWH.dbo.d_date 
		         	where 
		         	
		          datediff(day, date, current_timestamp) between 1 and 180  -- and 90 day lookback
		       
		         ) d
		         on s.joinkey = d.joinkey
		     
	        ) a
	         left outer join 
		  	(/* Daily Sales*/
		  		select d.dateskid, fp.siteskid,  sum(fp.ExtendedPrice ) as DailySales
		          from KMDWH.dbo.d_date d 
		          left outer join  KMDWH.dbo.f_pos fp on d.dateskid = fp.DateSkId 
		          --join KMDWH.dbo.d_site s on fp.SiteSKId  = s.SiteSkId 
		          where datediff(day, d.date, current_timestamp) between 1 and 180
		          --AND s.SiteDistrictKey ='D085'
		         group by fp.siteskid, d.dateskid
	         ) b  on a.dateskid = b.dateskid and a.siteskid = b.siteskid
	         left outer join
	         (/*Daily Inventory Adjustments*/
	
				select  
				fia.siteskid
				,fia.dateskid
				, sum(case when dac.ReasonCode  in (
						'1'  --Physical Inventory Posting  AC CatSju
						,'2' --QOH Update'
						,'3' --CC - Inventory Prep' 
						,'7' --Pour Off' 
						,'8' --Case to Each' 
						,'9' --Bad Product Formulation'
						,'10' --Rig Theft'  
						,'24' --Serial Adjustment
							)  then (fia.ShrinkageAmt+fia.ReceiveAmt+fia.QtyAdjAmt+fia.SalesAmt ) else 0 end ) as Defcon_amount
				,sum(fia.ShrinkageAmt+fia.ReceiveAmt+fia.QtyAdjAmt+fia.SalesAmt ) as total_adj_amount
				,count(1) as qty
				,count(distinct itemskid) as skus
				from 
				KMDWH.dbo.f_INVENTORY_ADJUST fia 
				join KMDWH.dbo.d_date d on fia.DateSkId  = d.DateSkId 
				join (Select * from KMDWH.dbo.D_ADJUST_CATEGORY where activeFlag = 'Y' ) dac on fia.AdjCatSkId  = dac.AdjCatSkId 
				where 
				 datediff(day, d.date, current_timestamp) between 1 and 180
				group by  
				fia.siteskid
				,fia.dateskid
			) c
	         on a.dateskid = c.dateskid and a.siteskid = c.siteskid
	         join KMDWH.dbo.d_date d on a.dateskid = d.DateSkId 
	         join KMDWH.dbo.d_site s on a.siteskid = s.siteskid
		where 	
			 s.SiteRegionKey IN ( 'EB' ,'INLD' ,'NRTH' ,'STH' ,'SW'  )
) y  
where 
datediff(day, y.date, current_timestamp) between 1 and 89 --Only the last 90 days or 180?
;

			insert into KMDWH.dbo.R_Script_Process_Log 
			select
			'tempAdjustments' --table name
			,5 
			,'Create  90 Day rolling Adjustments Temp table'
			,current_timestamp 
			from 
			(select dateskid from KMDWH.dbo.d_date where dateskid = 20200101 group by dateskid) a
			;
	
/*Step 6: 12 month Average Inventory & 12 Month COGS per Site  Temp tables  for past 90 days
 */
		
Select 
y.SiteSkId 
,d.[Date] 
,y.QOH_Value_12Mo_avg
into  #Temp_QOH_12Mo_Avg   
from 
	(select 
		x.siteskid
		,x.date
		,x.monthcode
		,avg(x.QOH_Value) OVER ( PARTITION BY x.siteskid  ORDER BY x.DATE rows BETWEEN 11 preceding  AND CURRENT row ) AS QOH_Value_12Mo_avg
	
		from(--Inventory Beg Balance on first day of month (which is ending balance on last day of prior month)
			SELECT 
			v.SiteSkId 
			,d.date
			,d.MonthCode 
			,cast(sum(v.ReplacementCostAmt * v.QtyOnHand) as integer)  as  QOH_Value
		FROM KMDWH.dbo.f_inventory v
			JOIN KMDWH.dbo.d_item i ON v.ItemSkId = i.ItemSkId
			JOIN KMDWH.dbo.d_site s ON v.SiteSkId = s.SiteSKId
			JOIN KMDWH.dbo.d_date d ON v.DateSkId = d.DateSkId
		WHERE 
			i.ItemDeptNo IN ( '100' ,'200' ,'300' ,'400' ) -- Only Depts 100 - 400
			and s.SiteRegionKey IN ( 'EB' ,'INLD' ,'NRTH' ,'STH' ,'SW'  ) -- Only Retail Regions
			AND s.SiteStatus = 'ACTIVE' -- only active stores
			and d.dayinMonth = 1
			and datediff(day, d.DATE, current_timestamp)  between 0 and 730 -- two years of Month-end balances
		group by 
			v.SiteSkId 
			,d.date
			,d.MonthCode 
		) x
	) y 
	join KMDWH.dbo.d_date d on y.monthcode = d.MonthCode 
where 	datediff(day, d.DATE, current_timestamp) between 0 and 89;

/* Daily COGS by Site*/

Select 
y.SiteSkId 
,d.[Date] 
,y.COGS_12months
into  #Temp_COGS_Last12Mos   
from 
(
	select 
		x.siteskid
		,case when x.calendarMonth = 12 then (x.MonthCode+1)+88 else monthcode+1 end as NextMonthCode
		,x.daily_COGS
		,sum(x.daily_COGS) OVER ( PARTITION BY x.siteskid  ORDER BY x.MonthCode rows BETWEEN 11 preceding  AND CURRENT row ) AS COGS_12months
	
		from

		(SELECT 
			p.siteskid
			,d.MonthCode 
			,d.CalendarMonth 
			,sum(p.ExtendedCost) daily_COGS
			
			FROM KMDWH.dbo.f_pos p  
				join KMDWH.dbo.d_item i on p.ItemSkId = i.itemskid
				JOIN KMDWH.dbo.d_date d ON p.DateSkId = d.DateSkId
			WHERE  datediff(day, d.DATE, current_timestamp) <= 730	
				and  i.ItemDeptNo IN ( '100' ,'200' ,'300' ,'400' )
					
			GROUP BY 
				p.siteskid
				,d.MonthCode
				,d.CalendarMonth 
				) x 
		) y 
		join KMDWH.dbo.d_date d on y.NextMonthCode = d.MonthCode 
		where 	datediff(day, d.DATE, current_timestamp) between 0 and 89;

			insert into KMDWH.dbo.R_Script_Process_Log 
			select
			'Temp_QOH_12Mo_Avg' --table name
			,6 
			,'Create 12-month Lookbacks : COGS and Avg Inventory'
			,current_timestamp 
			from 
			(select dateskid from KMDWH.dbo.d_date where dateskid = 20200101 group by dateskid) a
			;
	

		
		
/* Step 7: Qty on Hand
	Metric-by-Metric Insertion into Site/Date Reporting Table
 * 
 * expected runtime: 
 * table name: #temp_InventoryMetrics_Site
 * expected runtime:  1-2 minutes per metric
 * approx rows inserted: 15K  per metric
 * 
 * 
 * */	

	SELECT 
		s.SiteDistrictKey 
		,s.SiteRegionKey 
		,s.SiteNo 
		,date
		,cast('Site' as varchar(10)) AS tier
		,cast('Qty on Hand' AS varchar(32)) MetricName
		,cast(sum(v.QOH_Qty) as decimal(38,4)) AS Qty
		,cast(sum(v.QOH_Value) AS decimal(38,4)) AS Cost
		,cast(count(DISTINCT v.itemskid) as decimal(12,2)) AS SKUs
		,cast(max(1) as decimal(38,6)) AS PercentOfCost
		
		INTO  #temp_InventoryMetrics_Site
		
	FROM  #temp_InventoryMetrics_SKUDetail v join KMDWH.dbo.d_site s on v.siteskid  = s.SiteSkId 
	GROUP BY s.SiteDistrictKey 
		,s.SiteRegionKey 
		,s.SiteNo 
		,date
	;


			insert into KMDWH.dbo.R_Script_Process_Log 
			select
			'temp_InventoryMetrics_Site' --table name
			,7
			,'Qty on Hand - BEGIN Inserts into InventoryMetrics_Site'
			,current_timestamp 
			from 
			(select dateskid from KMDWH.dbo.d_date where dateskid = 20200101 group by dateskid) a
			;

	
/*STEP 8:  Negative QTY on Hand*/
	INSERT INTO   #temp_InventoryMetrics_Site  
	SELECT 
		s.SiteDistrictKey 
		,s.SiteRegionKey 
		,s.SiteNo 
		,date
		,'Site' AS tier
		,'Negative QtyOnHand' AS MetricName
		,sum(CASE 
				WHEN v.QOH_Qty < 0
					THEN v.QOH_Qty * - 1
				ELSE 0
				END) AS Qty
		,isnull(cast(sum(CASE 
						WHEN v.QOH_Qty < 0
							THEN v.QOH_Value * - 1
						END) AS float), 0) AS Cost
		,isnull(cast(count(DISTINCT CASE 
						WHEN v.QOH_Qty < 0
							THEN v.itemskid
						END) AS float), 0) AS SKUs
		,isnull(cast(sum(CASE 
						WHEN v.QOH_Qty < 0
							THEN v.QOH_Value * - 1
						END) AS float) / cast(sum(v.QOH_Value) AS float), 0) AS PercentOfCost
						
	FROM  #temp_InventoryMetrics_SKUDetail v join KMDWH.dbo.d_site s on v.siteskid  = s.SiteSkId 
	GROUP BY s.SiteDistrictKey 
		,s.SiteRegionKey 
		,s.SiteNo 
		,date
	;


			insert into KMDWH.dbo.R_Script_Process_Log 
			select
			'temp_InventoryMetrics_Site' --table name
			,8 -- 
			,'Total Neg QTY on Hand'
			,current_timestamp 
			from 
			(select dateskid from KMDWH.dbo.d_date where dateskid = 20200101 group by dateskid) a
			;

/*STEP 9:   NQOH > 7 days */
	INSERT INTO   #temp_InventoryMetrics_Site 
	SELECT   
		s.SiteDistrictKey 
		,s.SiteRegionKey 
		,s.SiteNo 
		,date
		,'Site' AS tier
		,'Negative QtyOnHand > 7 Days' AS MetricName
		,sum(CASE 
				WHEN v.NQOH_Days > 7
					THEN v.QOH_Qty * - 1
				ELSE 0
				END) AS Qty
		,isnull(cast(sum(CASE 
						WHEN v.NQOH_Days > 7
							THEN v.QOH_Value * - 1
						END) AS DECIMAL(10, 2)), 0) AS cost
		,isnull(cast(count(DISTINCT CASE 
						WHEN v.NQOH_Days > 7
							THEN v.itemskid
						END) AS DECIMAL(10, 2)), 0) AS skus
		,CASE 
			WHEN isnull(sum(v.QOH_Value), 0) = 0
				THEN 0
			ELSE isnull(cast(sum(CASE 
								WHEN v.NQOH_Days > 7
									THEN v.QOH_Value * - 1
								END) / cast(sum(v.QOH_Value) AS float) AS float), 0)
			END AS PercentOfCost
	FROM  #temp_InventoryMetrics_SKUDetail v join KMDWH.dbo.d_site s on v.siteskid  = s.SiteSkId 
	GROUP BY s.SiteDistrictKey 
		,s.SiteRegionKey 
		,s.SiteNo 
		,date
		;
	
	
			insert into KMDWH.dbo.R_Script_Process_Log 
			select
			'temp_InventoryMetrics_Site' --table name
			,9 -- 
			,'Negative QtyOnHand > 7 Days'
			,current_timestamp 
			from 
			(select dateskid from KMDWH.dbo.d_date where dateskid = 20200101 group by dateskid) a
			;
	
	/*STEP 10: Qty in Transit*/
	INSERT INTO   #temp_InventoryMetrics_Site 	
	SELECT 
		s.SiteDistrictKey 
		,s.SiteRegionKey 
		,s.SiteNo 
		,date
		,'Site' AS tier
		,'Qty in Transit' AS MetricName
		,isnull(sum(CASE 
					WHEN v.QIT_Qty > 0
						THEN v.QIT_Qty
					END), 0) AS qty -- ONLY Positive QTY in Transit Values
		,isnull(cast(sum(CASE 
						WHEN v.QIT_Qty > 0
							THEN v.QIT_Value
						END) AS DECIMAL(10, 2)), 0) AS cost
		,isnull(cast(count(DISTINCT CASE 
						WHEN v.QIT_Qty > 0
							THEN v.itemskid
						END) AS DECIMAL(10, 2)), 0) AS skus
		,CASE 
			WHEN sum(v.QOH_Value) = 0
				THEN 0
			ELSE isnull(cast(sum(CASE 
								WHEN v.QIT_Qty > 0
									THEN v.QIT_Value
								END) AS float), 0) / cast(sum(v.QOH_Value) AS float)
			END AS PercentOfCost
	FROM  #temp_InventoryMetrics_SKUDetail v join KMDWH.dbo.d_site s on v.siteskid  = s.SiteSkId 
	GROUP BY s.SiteDistrictKey 
		,s.SiteRegionKey 
		,s.SiteNo 
		,date
	;

			insert into KMDWH.dbo.R_Script_Process_Log 
			select
			'temp_InventoryMetrics_Site' --table name
			,10 
			,'Qty in Transit'
			,current_timestamp 
			from 
			(select dateskid from KMDWH.dbo.d_date where dateskid = 20200101 group by dateskid) a
			;


/*STEP 11:  Qty in Transit  > 3 Days*/
	INSERT INTO   #temp_InventoryMetrics_Site 
	SELECT 
		s.SiteDistrictKey 
		,s.SiteRegionKey 
		,s.SiteNo 
		,date
		,'Site' AS tier
		,'Qty in Transit > 3 Days' AS MetricName
		,sum(CASE 
				WHEN QIT_Days > 3
					AND v.QIT_Qty > 0
					THEN v.QIT_Qty
				ELSE 0
				END) AS qty
		,abs(isnull(cast(sum(CASE 
							WHEN QIT_Days > 3
								AND v.QIT_Qty > 0
								THEN v.QIT_value
							END) AS DECIMAL(10, 2)), 0)) AS cost
		,isnull(cast(count(DISTINCT CASE 
						WHEN QIT_Days > 3
							AND v.QIT_Qty > 0
							THEN v.itemskid
						END) AS DECIMAL(10, 2)), 0) AS skus
		,CASE 
			WHEN sum(v.QOH_Value) = 0
				THEN 0
			ELSE isnull(cast(sum(CASE 
								WHEN QIT_Days > 3
									AND v.QIT_Qty > 0
									THEN v.QIT_Value
								END) AS float), 0) / cast(sum(v.QOH_Value) AS float)
			END AS PercentOfCost
	FROM  #temp_InventoryMetrics_SKUDetail v join KMDWH.dbo.d_site s on v.siteskid  = s.SiteSkId 
	GROUP BY s.SiteDistrictKey 
		,s.SiteRegionKey 
		,s.SiteNo 
		,date
	;

			insert into KMDWH.dbo.R_Script_Process_Log 
			select
			'temp_InventoryMetrics_Site' --table name
			,11 -- 
			,'Qty in Transit > 3 Days'
			,current_timestamp 
			from 
			(select dateskid from KMDWH.dbo.d_date where dateskid = 20200101 group by dateskid) a
			;


/*STEP 12: Qty on Reserve*/
	INSERT INTO  #temp_InventoryMetrics_Site  	
	SELECT 
		s.SiteDistrictKey 
		,s.SiteRegionKey 
		,s.SiteNo 
		,date
		,'Site' AS tier
		,'Qty on Reserve' AS MetricName
		,isnull(sum(CASE 
					WHEN v.QR_Qty > 0
						THEN v.QR_Qty
					END), 0) AS qty -- ONLY Positive QTY in Transit Values
		,isnull(cast(sum(CASE 
						WHEN v.QR_Qty > 0
							THEN v.QR_Value
						END) AS DECIMAL(10, 2)), 0) AS cost
		,isnull(cast(count(DISTINCT CASE 
						WHEN v.QR_Qty > 0
							THEN v.itemskid
						END) AS DECIMAL(10, 2)), 0) AS skus
		,CASE 
			WHEN sum(v.QOH_Value) = 0
				THEN 0
			ELSE isnull(cast(sum(CASE 
								WHEN v.QR_Qty > 0
									THEN v.QR_Value
								END) AS float), 0) / cast(sum(v.QOH_Value) AS float)
			END AS PercentOfCost
	FROM #temp_InventoryMetrics_SKUDetail v join KMDWH.dbo.d_site s on v.siteskid  = s.SiteSkId 
	GROUP BY s.SiteDistrictKey 
		,s.SiteRegionKey 
		,s.SiteNo 
		,date
		;
	
	
				insert into KMDWH.dbo.R_Script_Process_Log 
			select
			'temp_InventoryMetrics_Site' --table name
			,12
			,'Qty on Reserve'
			,current_timestamp 
			from 
			(select dateskid from KMDWH.dbo.d_date where dateskid = 20200101 group by dateskid) a
			;
	
	
	/* Step 13: Qty on Reserve > 7 days*/
	
	INSERT INTO  #temp_InventoryMetrics_Site  
	SELECT 
		s.SiteDistrictKey 
		,s.SiteRegionKey 
		,s.SiteNo 
		,date
		,'Site' AS tier
		,'Qty on Reserve > 7 Days' AS MetricName
		,isnull(sum(CASE 
					WHEN v.QR_Qty > 0
						AND QR_Days > 7
						THEN v.QR_Qty
					END), 0) AS qty -- ONLY Positive QTY in Transit Values
		,isnull(cast(sum(CASE 
						WHEN v.QR_Qty > 0
							AND QR_Days > 7
							THEN v.QR_Value
						END) AS DECIMAL(10, 2)), 0) AS cost
		,isnull(cast(count(DISTINCT CASE 
						WHEN v.QR_Qty > 0
							AND QR_Days > 7
							THEN v.itemskid
						END) AS DECIMAL(10, 2)), 0) AS skus
		,CASE 
			WHEN sum(v.QOH_Value) = 0
				THEN 0
			ELSE isnull(cast(sum(CASE 
								WHEN v.QR_Qty > 0
									AND QR_Days > 7
									THEN v.QR_Value
								END) AS float), 0) / cast(sum(v.QOH_Value) AS float)
			END AS PercentOfCost
	FROM #temp_InventoryMetrics_SKUDetail v join KMDWH.dbo.d_site s on v.siteskid  = s.SiteSkId 
	GROUP BY s.SiteDistrictKey 
		,s.SiteRegionKey 
		,s.SiteNo 
		,date
		;
	
				insert into KMDWH.dbo.R_Script_Process_Log 
			select
			'temp_InventoryMetrics_Site' --table name
			,13
			,'Qty on Reserve > 7 Days'
			,current_timestamp 
			from 
			(select dateskid from KMDWH.dbo.d_date where dateskid = 20200101 group by dateskid) a
			;
	
	
	/* Step 14: Qty on Order*/
	INSERT INTO  #temp_InventoryMetrics_Site 
	SELECT 
		s.SiteDistrictKey 
		,s.SiteRegionKey 
		,s.SiteNo 
		,date
		,'Site' AS tier
		,'Qty on Order' AS MetricName
		,isnull(sum(v.QO_Qty), 0) AS qty
		,isnull(cast(sum(v.QO_Value) AS DECIMAL(10, 2)), 0) AS cost
		,isnull(cast(count(DISTINCT CASE 
						WHEN v.QO_Qty > 0
							THEN v.itemskid
						END) AS DECIMAL(10, 2)), 0) AS skus
		,CASE 
			WHEN sum(v.QOH_Value) = 0
				THEN 0
			ELSE isnull(cast(sum(v.QO_Value) AS float) / cast(sum(v.QOH_Value) AS float), 0)
			END AS PercentOfCost
	FROM #temp_InventoryMetrics_SKUDetail v join KMDWH.dbo.d_site s on v.siteskid  = s.SiteSkId 
	GROUP BY s.SiteDistrictKey 
		,s.SiteRegionKey 
		,s.SiteNo 
		,date;
	
				insert into KMDWH.dbo.R_Script_Process_Log 
			select
			'temp_InventoryMetrics_Site' --table name
			,14 
			,'Qty on Order'
			,current_timestamp 
			from 
			(select dateskid from KMDWH.dbo.d_date where dateskid = 20200101 group by dateskid) a
			;
	

/* Step 15: Qty on Order > 3 Days*/	
INSERT INTO  #temp_InventoryMetrics_Site  --6i:  QO > 3
	SELECT 
		s.SiteDistrictKey 
		,s.SiteRegionKey 
		,s.SiteNo 
		,date
		,'Site' AS tier
		,'Qty on Order > 3 Days' AS MetricName
		,isnull(sum(CASE 
					WHEN QO_Days > 3
						THEN v.QO_Qty
					END), 0) AS qty
		,isnull(cast(sum(CASE 
						WHEN QO_Days > 3
							THEN v.QO_Value
						END) AS DECIMAL(10, 2)), 0) AS cost
		,isnull(cast(count(DISTINCT CASE 
						WHEN QO_Days > 3
							AND v.QO_Qty > 0
							THEN v.itemskid
						END) AS DECIMAL(10, 2)), 0) AS skus
		,CASE 
			WHEN sum(v.QOH_Value) = 0
				THEN 0
			ELSE isnull(cast(sum(CASE 
								WHEN QO_Days > 3
									THEN v.QO_Value
								END) AS float) / cast(sum(v.QOH_Value) AS float), 0)
			END AS PercentOfCost
	FROM #temp_InventoryMetrics_SKUDetail v join KMDWH.dbo.d_site s on v.siteskid  = s.SiteSkId 
	GROUP BY s.SiteDistrictKey 
		,s.SiteRegionKey 
		,s.SiteNo 
		,date;
	
				insert into KMDWH.dbo.R_Script_Process_Log 
			select
			'temp_InventoryMetrics_Site' --table name
			,15
			,'Qty on Order > 3 Days'
			,current_timestamp 
			from 
			(select dateskid from KMDWH.dbo.d_date where dateskid = 20200101 group by dateskid) a
			;
	
	
	/* Step 16: Qty on BackOrder*/	
	INSERT INTO  #temp_InventoryMetrics_Site  
	SELECT 
		s.SiteDistrictKey 
		,s.SiteRegionKey 
		,s.SiteNo 
		,date
		,'Site' AS tier
		,'Qty on BackOrder' AS MetricName
		,isnull(sum(v.QBO_Qty), 0) AS qty
		,isnull(cast(sum(v.QBO_Value) AS DECIMAL(10, 2)), 0) AS cost
		,isnull(cast(count(DISTINCT CASE 
						WHEN v.QBO_Qty > 0
							THEN v.itemskid
						END) AS DECIMAL(10, 2)), 0) AS skus
		,CASE 
			WHEN sum(v.QOH_Value) = 0
				THEN 0
			ELSE isnull(cast(sum(v.QBO_Value) AS float) / cast(sum(v.QOH_Value) AS float), 0)
			END AS PercentOfCost
	FROM #temp_InventoryMetrics_SKUDetail v join KMDWH.dbo.d_site s on v.siteskid  = s.SiteSkId 
	GROUP BY s.SiteDistrictKey 
		,s.SiteRegionKey 
		,s.SiteNo 
		,date
		;
	
	
			insert into KMDWH.dbo.R_Script_Process_Log 
			select
			'temp_InventoryMetrics_Site' --table name
			,16 
			,'Qty on BackOrder'
			,current_timestamp 
			from 
			(select dateskid from KMDWH.dbo.d_date where dateskid = 20200101 group by dateskid) a
			;
	
	/* Step 17: Qty on BackOrder > 7 Days*/	
	INSERT INTO  #temp_InventoryMetrics_Site  
	SELECT 
		s.SiteDistrictKey 
		,s.SiteRegionKey 
		,s.SiteNo 
		,date
		,'Site' AS tier
		,'Qty on BackOrder > 7 Days' AS MetricName
		,isnull(sum(CASE 
					WHEN QBO_Days > 7
						THEN v.QBO_Qty
					END), 0) AS qty
		,isnull(cast(sum(CASE 
						WHEN QBO_Days > 7
							THEN v.QBO_Value
						END) AS DECIMAL(10, 2)), 0) AS cost
		,isnull(cast(count(DISTINCT CASE 
						WHEN QBO_Days > 7
							THEN v.itemskid
						END) AS DECIMAL(10, 2)), 0) AS skus
		,CASE 
			WHEN sum(v.QOH_Value) = 0
				THEN 0
			ELSE isnull(cast(sum(CASE 
								WHEN QBO_Days > 7
									THEN v.QBO_Value
								END) AS float) / cast(sum(v.QOH_Value) AS float), 0)
			END AS PercentOfCost
	FROM #temp_InventoryMetrics_SKUDetail v join KMDWH.dbo.d_site s on v.siteskid  = s.SiteSkId 
	GROUP BY s.SiteDistrictKey 
		,s.SiteRegionKey 
		,s.SiteNo 
		,date
		;

			insert into KMDWH.dbo.R_Script_Process_Log 
			select
			'temp_InventoryMetrics_Site' --table name
			,17
			,'Qty on BackOrder > 7 Days'
			,current_timestamp 
			from 
			(select dateskid from KMDWH.dbo.d_date where dateskid = 20200101 group by dateskid) a
			;
	
	
	/* Step 18: Slow Moving SKUs*/	
	INSERT INTO  #temp_InventoryMetrics_Site  
	SELECT 
		s.SiteDistrictKey 
		,s.SiteRegionKey 
		,s.SiteNo 
		,date
		,'Site' AS tier
		,'Slow Moving Inventory' AS MetricName
		,sum(CASE 
				WHEN v.slow_moving_sku = 1
					THEN v.QOH_Qty
				END) AS qty
		,isnull(cast(sum(CASE 
						WHEN v.slow_moving_sku = 1
							THEN v.QOH_Value
						END) AS float), 0) AS cost
		,isnull(cast(sum(v.slow_moving_sku) AS float), 0) AS Skus
		,CASE 
			WHEN isnull(sum(v.QOH_Value), 0) = 0
				THEN 0
			ELSE isnull(cast(sum(CASE 
								WHEN v.slow_moving_sku = 1
									THEN v.QOH_Value
								END) AS float) / cast(sum(v.QOH_Value) AS float), 0)
			END AS PercentOfCost
	FROM #temp_InventoryMetrics_SKUDetail v join KMDWH.dbo.d_site s on v.siteskid  = s.SiteSkId 
	GROUP BY s.SiteDistrictKey 
		,s.SiteRegionKey 
		,s.SiteNo 
		,date
		;
	
			insert into KMDWH.dbo.R_Script_Process_Log 
			select
			'temp_InventoryMetrics_Site' --table name
			,18
			,'Slow Moving Inventory'
			,current_timestamp 
			from 
			(select dateskid from KMDWH.dbo.d_date where dateskid = 20200101 group by dateskid) a
			;
	
	
	
	/* Step 19: Days on Hand < 7*/	
	INSERT INTO  #temp_InventoryMetrics_Site  
	SELECT 
		s.SiteDistrictKey 
		,s.SiteRegionKey 
		,s.SiteNo 
		,date
		,'Site' AS tier
		,'Days on Hand < 7' AS MetricName
		,sum(CASE 
				WHEN v.days_on_hand < 7
					AND v.prior_365_COGS > 0
					AND v.QOH_qty > 0
					THEN v.QOH_qty
				END) AS qty
		,isnull(cast(sum(CASE 
						WHEN v.days_on_hand < 7
							AND v.prior_365_COGS > 0
							AND v.QOH_Qty > 0
							THEN v.QOH_Value
						END) AS DECIMAL(10, 2)), 0) AS Cost
		,isnull(cast(count(DISTINCT CASE 
						WHEN v.days_on_hand < 7
							AND v.prior_365_COGS > 0
							AND v.QOH_Qty > 0
							THEN v.itemskid
						END) AS DECIMAL(10, 2)), 0) AS Skus
		,CASE 
			WHEN isnull(sum(v.QOH_Value), 0) = 0
				THEN 0
			ELSE isnull(cast(sum(CASE 
								WHEN v.days_on_hand < 7
									AND v.prior_365_COGS > 0
									AND v.QOH_Qty > 0
									THEN v.QOH_Value
								END) AS float), 0) / cast(sum(v.QOH_Value) AS float)
			END AS PercentOfCost
	FROM #temp_InventoryMetrics_SKUDetail v join KMDWH.dbo.d_site s on v.siteskid  = s.SiteSkId 
	GROUP BY s.SiteDistrictKey 
		,s.SiteRegionKey 
		,s.SiteNo 
		,date
		;
	
			insert into KMDWH.dbo.R_Script_Process_Log 
			select
			'temp_InventoryMetrics_Site' --table name
			,19 
			,'Days on Hand < 7 Days'
			,current_timestamp 
			from 
			(select dateskid from KMDWH.dbo.d_date where dateskid = 20200101 group by dateskid) a
			;

	
	
	/* Step 20: Turns*/	
	INSERT INTO  #temp_InventoryMetrics_Site  
	
	SELECT 
		s.SiteDistrictKey 
		,s.SiteRegionKey 
		,s.SiteNo 
		,y.date
		,'Site' AS tier
		,'Turns & Prior 365 Days Sales' AS MetricName
		,sum(QOH_Value_12Mo_avg) AS qty  --12 month avg inventory
		,sum(v.COGS_12months) AS Cost  --Avg of past 12 month-end Balances
		,max(1) AS Skus
		,cast(sum(v.COGS_12months) AS float) / cast(sum(y.QOH_Value_12Mo_avg) AS float) AS PercentOfCost

	FROM 
		 #Temp_COGS_Last12Mos  v 
			join KMDWH.dbo.d_site s on v.siteskid  = s.SiteSkId 
			join #Temp_QOH_12Mo_Avg y on y.siteskid = v.siteskid and y.date = v.date
							
	GROUP BY s.SiteDistrictKey 
		,s.SiteRegionKey 
		,s.SiteNo 
		,y.date

	HAVING sum(y.QOH_Value_12Mo_avg) > 0;
	


			insert into KMDWH.dbo.R_Script_Process_Log 
			select
			'temp_InventoryMetrics_Site' --table name
			,20 
			,'Turns & Prior 365 Days Sales'
			,current_timestamp 
			from 
			(select dateskid from KMDWH.dbo.d_date where dateskid = 20200101 group by dateskid) a
			;

		

	/* Step 21: Days Since Last Close*/	
	INSERT INTO   #temp_InventoryMetrics_Site  
	SELECT 
		s.SiteDistrictKey 
		,s.SiteRegionKey 
		,s.SiteNo 
		,d1.DATE
		,'Site' AS tier
		,'Days Since Last Close' AS metricName
		,max(datediff(day, d2.DATE, d1.DATE) - 1) AS qty
		,NULL cost
		,NULL AS skus
		,NULL AS PercentOfCost

	FROM KMDWH.dbo.d_site s
	JOIN KMDWH.dbo.f_INVENTORY v ON s.SiteSkId = v.SiteSkId
	JOIN KMDWH.dbo.d_date d1 ON v.DateSkId = d1.DateSkId
	JOIN KMDWH.dbo.d_date d2 ON s.SiteLastDayClosedDt = d2.dateSkid
	join (select distinct siteskid from  #temp_InventoryMetrics_SKUDetail) sd on s.siteskid = sd.siteskid
	WHERE d1.DATE = ( SELECT max(DATE) FROM  #temp_InventoryMetrics_SKUDetail )
	GROUP BY s.SiteDistrictKey 
		,s.SiteRegionKey 
		,s.SiteNo 
		,d1.DATE
		;

			insert into KMDWH.dbo.R_Script_Process_Log 
			select
			'temp_InventoryMetrics_Site' --table name
			,21 
			,'Days Since Last Close'
			,current_timestamp 
			from 
			(select dateskid from KMDWH.dbo.d_date where dateskid = 20200101 group by dateskid) a
			;
	
	
	
	/* Step 22: Days Since Last Safe Withdrawal*/	
	INSERT INTO  #temp_InventoryMetrics_Site 

	SELECT 
		s.SiteDistrictKey 
		,s.SiteRegionKey 
		,s.SiteNo 
		,d1.DATE
		,'Site' AS tier
		,'Days Since Last Safe Withdrawal' AS metricName
		,max(datediff(day, d2.DATE, d1.DATE) - 1) AS qty
		,NULL cost
		,NULL AS skus
		,NULL AS PercentOfCost
	FROM KMDWH.dbo.d_site s
	JOIN KMDWH.dbo.f_INVENTORY v ON s.SiteSkId = v.SiteSkId
	JOIN KMDWH.dbo.d_date d1 ON v.DateSkId = d1.DateSkId
	JOIN KMDWH.dbo.d_date d2 ON s.siteLastSafeWithdrawDt = d2.dateSkid
	join (select distinct siteskid from  #temp_InventoryMetrics_SKUDetail) sd on s.siteskid = sd.siteskid
	WHERE d1.DATE = ( SELECT max(DATE) FROM  #temp_InventoryMetrics_SKUDetail )
	GROUP BY s.SiteDistrictKey 
		,s.SiteRegionKey 
		,s.SiteNo 
		,d1.DATE
		;

			insert into KMDWH.dbo.R_Script_Process_Log 
			select
			'temp_InventoryMetrics_Site' --table name
			,22
			,'Days Since Last Safe Withdrawal'
			,current_timestamp 
			from 
			(select dateskid from KMDWH.dbo.d_date where dateskid = 20200101 group by dateskid) a
			;
	
	

/* Step 23: Total Sales-Last 90*/
INSERT INTO  #temp_InventoryMetrics_Site  
	SELECT 
		SiteDistrictKey 
		,SiteRegionKey 
		,SiteNo 
		,DATE
		,'Site' AS tier
		,'Total Sales-Last 90' AS MetricName
		,0 as Qty
		,a.TotalSales_90dayRolling  AS Cost
		,0 AS SKUs
		,0  AS PercentOfCost
	FROM
	 #tempAdjustments a
	;

			insert into KMDWH.dbo.R_Script_Process_Log 
			select
			'temp_InventoryMetrics_Site' --table name
			,23 
			,'Total Sales-Last 90'
			,current_timestamp 
			from 
			(select dateskid from KMDWH.dbo.d_date where dateskid = 20200101 group by dateskid) a
			;
	


/* Step 24: Total Adjustments-Last 90*/
INSERT INTO  #temp_InventoryMetrics_Site  
	SELECT 
		SiteDistrictKey 
		,SiteRegionKey 
		,SiteNo 
		,DATE
		,'Site' AS tier
		,'Total Adjustments-Last 90' AS MetricName
		,0 as Qty
		,a.TotalAdjAmt_90dayRolling  AS Cost
		,0 AS SKUs
		,case when TotalSales_90dayRolling = 0 then 0 else cast(a.TotalAdjAmt_90dayRolling as float) / cast( TotalSales_90dayRolling as float) end AS PercentOfCost
	FROM
	 #tempAdjustments a
	;

			insert into KMDWH.dbo.R_Script_Process_Log 
			select
			'temp_InventoryMetrics_Site' --table name
			,24
			,'Total Adjustments-Last 90'
			,current_timestamp 
			from 
			(select dateskid from KMDWH.dbo.d_date where dateskid = 20200101 group by dateskid) a
			;

/* Step 25: 'Qty Received (not posted)'*/
		INSERT 	INTO  #temp_InventoryMetrics_Site  
		SELECT 
		s.SiteDistrictKey 
		,s.SiteRegionKey 
		,s.SiteNo 
		,max(cast(current_timestamp as date)) as dt
		,'Site' AS tier
		,'Qty Received (not posted)' AS metricName
		,isnull(max(TransactionAge) ,0) AS qty  --Qty = Max Days outstanding
		,isnull(sum(v.detail_cost ),0) cost
		,isnull(count(distinct v.ItemSkuNo ),0) skus
		,0 AS PercentOfCost
	
	FROM KMDWH.dbo.d_site s --(select SiteNo, SiteDistrictKey, SiteRegionKey from KMDWH.dbo.d_site where )  s
	left outer join 
	(select * from  KMDWH.dbo.vw_InventoryMetrics_Detail_Transactions  where metricname = 'Qty Received (not posted)') v ON s.SiteNo = v.SiteNo
	where 
	s.SiteRegionKey IN ( 'EB' ,'INLD' ,'NRTH' ,'STH' ,'SW'  ) and s.siteStatus = 'ACTIVE'
	group by
	s.SiteDistrictKey 
		,s.SiteRegionKey 
		,s.SiteNo ;

		;

			insert into KMDWH.dbo.R_Script_Process_Log 
			select
			'temp_InventoryMetrics_Site' --table name
			,25
			,'Qty Received (not posted)'
			,current_timestamp 
			from 
			(select dateskid from KMDWH.dbo.d_date where dateskid = 20200101 group by dateskid) a
			;
	

/* Step 26: Defcon Adjustments-Last 90*/
	INSERT INTO  #temp_InventoryMetrics_Site  
	SELECT 
		SiteDistrictKey 
		,SiteRegionKey 
		,SiteNo 
		,DATE
		,'Site' AS tier
		,'Defcon Adjustments-Last 90' AS MetricName
		,0 as Qty
		,a.TotalDefconAmt_90dayRolling  AS Cost
		,0 AS SKUs
		,case when TotalSales_90dayRolling = 0 then 0 else cast(a.TotalDefconAmt_90dayRolling as float) / cast( TotalSales_90dayRolling as float) end AS PercentOfCost
	FROM
	 #tempAdjustments a
	;
	
			insert into KMDWH.dbo.R_Script_Process_Log 
			select
			'temp_InventoryMetrics_Site' --table name
			,26
			,'Defcon Adjustments-Last 90'
			,current_timestamp 
			from 
			(select dateskid from KMDWH.dbo.d_date where dateskid = 20200101 group by dateskid) a
			;
	

		
	/* Step 27: Qty on Hand - 90Day Avg*/	
	INSERT INTO  #temp_InventoryMetrics_Site  
	SELECT 
		s.SiteDistrictKey 
		,s.SiteRegionKey 
		,s.SiteNo 
		,date
		,'Site' AS tier
		,'QOH 90-Day Avg' AS MetricName
		,sum(v.QOH_Qty_90D_avg) AS qty
		,sum(v.QOH_Value_90D_avg) AS Cost
		,max(1) AS Skus
		,0 AS PercentOfCost
	FROM #temp_InventoryMetrics_SKUDetail v join KMDWH.dbo.d_site s on v.siteskid  = s.SiteSkId 
	GROUP BY s.SiteDistrictKey 
		,s.SiteRegionKey 
		,s.SiteNo 
		,date

	;

			insert into KMDWH.dbo.R_Script_Process_Log 
			select
			'temp_InventoryMetrics_Site' --table name
			,27 
			,'Qty on Hand - 90Day Avg'
			,current_timestamp 
			from 
			(select dateskid from KMDWH.dbo.d_date where dateskid = 20200101 group by dateskid) a
			;
		
	
		
/* Complete Inserts to InventoryMetrics_Site*/


		
/* Step 28: Create District level Detail reporting table*/

SELECT  
	DATE
	,siteDistrictKey
	,siteRegionKey
	,'District' AS tier
	,MetricName
	,avg(qty) AS AvgQty
	,avg(Cost) AS AvgCost
	,avg(skus) AS AvgSkus
	,avg(PercentOfCost) AS AvgPercentOfCost
	
	INTO   #temp_InventoryMetrics_District
	
FROM  #temp_InventoryMetrics_Site x 
GROUP BY DATE
	,siteDistrictKey
	,siteRegionKey
	,MetricName;

			insert into KMDWH.dbo.R_Script_Process_Log 
			select
			'temp_InventoryMetrics_District' --table name
			,28 
			,'Create District level Detail reporting table'
			,current_timestamp 
			from 
			(select dateskid from KMDWH.dbo.d_date where dateskid = 20200101 group by dateskid) a
			;
	


/* Step 29: Create Region level Detail reporting table*/
SELECT 
	DATE
	,siteRegionKey
	,'Region' AS tier
	,MetricName
	/* MEDIAN CALCS might be better
        , (PERCENTILE_DISC(0.5) WITHIN GROUP (ORDER BY Cost)   
                            OVER (PARTITION BY date, siteRegionKey,MetricName)) AS MedianCost   */
	,avg(qty) AS AvgQty
	,avg(Cost) AS AvgCost
	,avg(skus) AS AvgSkus
	,avg(PercentOfCost) AS AvgPercentOfCost
	
	INTO  #temp_InventoryMetrics_Region
	
FROM  #temp_InventoryMetrics_Site x 
GROUP BY DATE
	,siteRegionKey
	,MetricName;

			insert into KMDWH.dbo.R_Script_Process_Log 
			select
			'temp_InventoryMetrics_Region' --table name
			,29 
			,'Create Region level Detail reporting table'
			,current_timestamp 
			from 
			(select dateskid from KMDWH.dbo.d_date where dateskid = 20200101 group by dateskid) a
			;


/* Step 30: Create Company level Detail reporting table*/
SELECT DATE
	,'Company' AS tier
	,MetricName
	,avg(qty) AS AvgQty
	,avg(Cost) AS AvgCost
	,avg(skus) AS AvgSkus
	,avg(PercentOfCost) AS AvgPercentOfCost
	
	INTO  #temp_InventoryMetrics_Company
	
FROM  #temp_InventoryMetrics_Site x
GROUP BY DATE
	,MetricName;

			insert into KMDWH.dbo.R_Script_Process_Log 
			select
			'temp_InventoryMetrics_Region' --table name
			,30 
			,'Create Company level Detail reporting table'
			,current_timestamp 
			from 
			(select dateskid from KMDWH.dbo.d_date where dateskid = 20200101 group by dateskid) a
			;

/* Step 31: replace Contents of R_Inventory_Metrics_SKU*/
truncate table KMDWH.dbo.R_Inventory_Metrics_SKU;
Insert into KMDWH.dbo.R_Inventory_Metrics_SKU select * from #temp_InventoryMetrics_SKUDetail;

			insert into KMDWH.dbo.R_Script_Process_Log 
			select
			'R_Inventory_Metrics_SKU' --table name
			,31 
			,'Truncate and load KMDWH.dbo.R_Inventory_Metrics_SKU'
			,current_timestamp 
			from 
			(select dateskid from KMDWH.dbo.d_date where dateskid = 20200101 group by dateskid) a
			;


/* Step 32: replace Contents of KMDWH.dbo.R_Inventory_Metrics_Site*/
truncate table KMDWH.dbo.R_Inventory_Metrics_Site;
Insert into KMDWH.dbo.R_Inventory_Metrics_Site select * from #temp_InventoryMetrics_Site;

		insert into KMDWH.dbo.R_Script_Process_Log 
		select
			'R_Inventory_Metrics_Site' --table name
			,32
			,'Truncate and load KMDWH.dbo.R_Inventory_Metrics_Site'
			,current_timestamp 
			from 
			(select dateskid from KMDWH.dbo.d_date where dateskid = 20200101 group by dateskid) a
			;

/* Step 33: replace Contents of KMDWH.dbo.R_Inventory_Metrics_District*/
truncate table KMDWH.dbo.R_Inventory_Metrics_District;
Insert into KMDWH.dbo.R_Inventory_Metrics_District select *  from #temp_InventoryMetrics_District;


			insert into KMDWH.dbo.R_Script_Process_Log
			select
			'R_Inventory_Metrics_District' --table name
			,33
			,'Truncate and load KMDWH.dbo.R_Inventory_Metrics_District'
			,current_timestamp 
			from 
			(select dateskid from KMDWH.dbo.d_date where dateskid = 20200101 group by dateskid) a
			;

/* Step 34: replace Contents of KMDWH.dbo.R_Inventory_Metrics_Region*/
truncate table KMDWH.dbo.R_Inventory_Metrics_Region;
Insert into KMDWH.dbo.R_Inventory_Metrics_Region select *  from #temp_InventoryMetrics_Region;


			insert into KMDWH.dbo.R_Script_Process_Log
			select
			'R_Inventory_Metrics_Region' --table name
			,34
			,'Truncate and load KMDWH.dbo.R_Inventory_Metrics_Region'
			,current_timestamp 
			from 
			(select dateskid from KMDWH.dbo.d_date where dateskid = 20200101 group by dateskid) a
			;

/* Step 35: replace Contents of KMDWH.dbo.R_Inventory_Metrics_Company*/
truncate table KMDWH.dbo.R_Inventory_Metrics_Company; 
Insert into KMDWH.dbo.R_Inventory_Metrics_Company select *  from #temp_InventoryMetrics_Company;


			insert into KMDWH.dbo.R_Script_Process_Log
			select
			'KMDWH.dbo.R_Inventory_Metrics_Company' --table name
			,35 
			,'Truncate and load KMDWH.dbo.R_Inventory_Metrics_Company'
			,current_timestamp 
			from 
			(select dateskid from KMDWH.dbo.d_date where dateskid = 20200101 group by dateskid) a
			;


		insert into KMDWH.dbo.R_Script_Process_Log
			select
			'KMDWH.dbo.R_Inventory_Metrics_Company' --table name
			,99 
			,'**** Complete Script Load ***'
			,current_timestamp 
			from 
			(select dateskid from KMDWH.dbo.d_date where dateskid = 20200101 group by dateskid) a
			;
